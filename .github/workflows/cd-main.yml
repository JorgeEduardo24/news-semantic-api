name: cd-main

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-test-push-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write   # OIDC/WIF

    env:
      EMBEDDING_BACKEND: fastembed
      MODEL_NAME: sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2
      QDRANT_HOST: localhost
      QDRANT_PORT: '6333'

    services:
      qdrant:
        image: qdrant/qdrant:latest
        ports:
          - 6333:6333

    steps:
      - uses: actions/checkout@v4

      # --- CI: tests ---------------------------------------------------------
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps (poetry)
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry config virtualenvs.create false
          poetry install --with dev

      - name: Wait for Qdrant to be ready
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:6333/collections >/dev/null; then
              echo "Qdrant is ready"
              exit 0
            fi
            echo "waiting qdrant ($i/60)"
            sleep 1
          done
          echo "Qdrant not ready"; docker logs ${{ job.services.qdrant.id }}; exit 1

      - name: Install spaCy ES model
        run: |
          python -m pip install --no-cache-dir \
            https://github.com/explosion/spacy-models/releases/download/es_core_news_md-3.8.0/es_core_news_md-3.8.0-py3-none-any.whl
          python -m spacy validate

      - name: Run tests
        run: pytest -q

      # --- Auth GCP + GAR + GKE ----------------------------------------------
      - name: Auth to GCP via WIF
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          install_components: 'gke-gcloud-auth-plugin'

      # --- Build & Push con ruta completa ------------------------------------
      - name: Build & push image (AR_REPO_PATH completo)
        env:
          AR_REPO_PATH: ${{ secrets.AR_REPO_PATH }}   # ej: us-central1-docker.pkg.dev/PROJECT/repo-id
        run: |
          set -euo pipefail
          test -f deploy/Dockerfile || { echo "No se encontrÃ³ deploy/Dockerfile"; ls -la deploy || true; exit 1; }

          HOST="${AR_REPO_PATH%%/*}"
          echo "HOST=$HOST"
          gcloud auth configure-docker "$HOST" -q

          IMAGE="${AR_REPO_PATH}/news-semantic-api:${GITHUB_SHA}"
          echo "IMAGE=$IMAGE"

          docker build -f deploy/Dockerfile -t "$IMAGE" .
          docker push "$IMAGE"

          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          echo "IMAGE_REPO=${IMAGE%:*}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${GITHUB_SHA}"  >> $GITHUB_ENV

      # --- Deploy (Helm) -----------------------------------------------------
      - uses: azure/setup-kubectl@v4
        with:
          version: v1.29.6
      - uses: azure/setup-helm@v4

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_REGION }}

      - name: Helm upgrade (API + Qdrant subchart)
        env:
          USE_GKE_GCLOUD_AUTH_PLUGIN: "True"
        run: |
          helm repo add qdrant https://qdrant.github.io/qdrant-helm || true
          helm repo update
          helm dependency update deploy/helm/news-semantic-api
          helm upgrade --install news-demo deploy/helm/news-semantic-api \
            --set image.repository="${{ env.IMAGE_REPO }}" \
            --set image.tag="${{ env.IMAGE_TAG }}" \
            -f deploy/helm/news-semantic-api/values.gke.yaml
